!function(e){"use strict";function t(){}var n=t.prototype,i=e.EventEmitter;function r(e,t){for(var n=e.length;n--;)if(e[n].listener===t)return n;return-1}function s(e){return function(){return this[e].apply(this,arguments)}}n.getListeners=function(e){var t,n,i=this._getEvents();if(e instanceof RegExp)for(n in t={},i)i.hasOwnProperty(n)&&e.test(n)&&(t[n]=i[n]);else t=i[e]||(i[e]=[]);return t},n.flattenListeners=function(e){for(var t=[],n=0;n<e.length;n+=1)t.push(e[n].listener);return t},n.getListenersAsObject=function(e){var t,n=this.getListeners(e);return n instanceof Array&&((t={})[e]=n),t||n},n.addListener=function(e,t){if(!function e(t){return"function"==typeof t||t instanceof RegExp||!(!t||"object"!=typeof t)&&e(t.listener)}(t))throw new TypeError("listener must be a function");var n,i=this.getListenersAsObject(e),s="object"==typeof t;for(n in i)i.hasOwnProperty(n)&&-1===r(i[n],t)&&i[n].push(s?t:{listener:t,once:!1});return this},n.on=s("addListener"),n.addOnceListener=function(e,t){return this.addListener(e,{listener:t,once:!0})},n.once=s("addOnceListener"),n.defineEvent=function(e){return this.getListeners(e),this},n.defineEvents=function(e){for(var t=0;t<e.length;t+=1)this.defineEvent(e[t]);return this},n.removeListener=function(e,t){var n,i,s=this.getListenersAsObject(e);for(i in s)s.hasOwnProperty(i)&&-1!==(n=r(s[i],t))&&s[i].splice(n,1);return this},n.off=s("removeListener"),n.addListeners=function(e,t){return this.manipulateListeners(!1,e,t)},n.removeListeners=function(e,t){return this.manipulateListeners(!0,e,t)},n.manipulateListeners=function(e,t,n){var i,s,r=e?this.removeListener:this.addListener,a=e?this.removeListeners:this.addListeners;if("object"!=typeof t||t instanceof RegExp)for(i=n.length;i--;)r.call(this,t,n[i]);else for(i in t)t.hasOwnProperty(i)&&(s=t[i])&&("function"==typeof s?r.call(this,i,s):a.call(this,i,s));return this},n.removeEvent=function(e){var t,n=typeof e,i=this._getEvents();if("string"==n)delete i[e];else if(e instanceof RegExp)for(t in i)i.hasOwnProperty(t)&&e.test(t)&&delete i[t];else delete this._events;return this},n.removeAllListeners=s("removeEvent"),n.emitEvent=function(e,t){var n,i,s,r,a=this.getListenersAsObject(e);for(r in a)if(a.hasOwnProperty(r))for(n=a[r].slice(0),s=0;s<n.length;s++)!0===(i=n[s]).once&&this.removeListener(e,i.listener),i.listener.apply(this,t||[])===this._getOnceReturnValue()&&this.removeListener(e,i.listener);return this},n.trigger=s("emitEvent"),n.emit=function(e){var t=Array.prototype.slice.call(arguments,1);return this.emitEvent(e,t)},n.setOnceReturnValue=function(e){return this._onceReturnValue=e,this},n._getOnceReturnValue=function(){return!this.hasOwnProperty("_onceReturnValue")||this._onceReturnValue},n._getEvents=function(){return this._events||(this._events={})},t.noConflict=function(){return e.EventEmitter=i,t},"function"==typeof define&&define.amd?define(function(){return t}):"object"==typeof module&&module.exports?module.exports=t:e.EventEmitter=t}("undefined"!=typeof window?window:this||{});"use strict";var Logger={debug:function(e){console.log(e)},info:function(e){console.log(e)},warn:function(e){console.log(e)},error:function(e){console.log(e)}};function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function _createClass(e,t,n){return t&&_defineProperties(e.prototype,t),n&&_defineProperties(e,n),e}function priorityCompare(e,t){return e.priority-t.priority}function printStack(e,t){for(var n="Channel["+e+"] = ",i=0;i<t.length;i++)0<i&&(n+=", "),n+=t[i].name+"("+t[i].priority+")";Logger.info(n)}var Channel=function(){function n(e,t){_classCallCheck(this,n),this.manager=e,this.name=t,this.schedules=[],this.checkCallback=this.check.bind(this)}return _createClass(n,[{key:"add",value:function(e){-1==this.schedules.indexOf(e)?(this.schedules.push(e),this.markDirty()):Logger.info("Schedule already active: "+e.name)}},{key:"remove",value:function(e){var t=this.schedules.indexOf(e);-1<t?(this.schedules.splice(t,1),this.markDirty()):Logger.warn("Error removing "+e.name+". Empty channel: "+e.channel)}},{key:"markDirty",value:function(){this.dirty=!0,this.timerId&&clearTimeout(this.timerId),this.timerId=setTimeout(this.checkCallback,100)}},{key:"check",value:function(){var e;clearTimeout(this.timerId),this.timerId=0,this.dirty&&0<this.schedules.length&&(this.dirty=!1,this.schedules.sort(priorityCompare),printStack(this.name,this.schedules),e=this.schedules[0],this.active!=e&&(this.active=e,this.manager.setNewContent(this.name,e,e.priorityTrigger)))}}]),n}(),AppboxPlayer=function(e){for(var t in this.id=e.id,this.version="1.0.1",this.controller={},e.channels){var n=$('<div id="'+(t+"-player")+'" class="root-stage"></div>');n.appendTo($("#"+t)),this.setChannel(e.channels[t],n[0])}};AppboxPlayer.prototype.connect=function(t){var e=this,n=new ScheduleManager,i=t||location.host;console.log("Connect to: "+i);var s=io(i,{reconnect:!0,path:"/signage"});s.on("connect",function(){console.log("Connected"),s.emit("init",{id:e.id,type:"player",version:e.version,scheduled:null!=e.schedules,bonus:e.bonus,platform:navigator.appName,os_variant:"browser"})}),s.on("schedules",function(e){t&&(e.host=t),n.processSchedules(e)}),n.on("channelContentChanged",this.onChannelChanged.bind(this))},AppboxPlayer.prototype.setChannel=function(e,t){this.controller[e]=new ChannelController(e,t)},AppboxPlayer.prototype.getChannels=function(){return this.controller},AppboxPlayer.prototype.getChannel=function(e){var t=this.controller[e];return t||(this.controller[e]=t=new ChannelController(e)),t},AppboxPlayer.prototype.stopChannel=function(e){this.pauseChannel(e)},AppboxPlayer.prototype.pauseChannel=function(e){var t=this.controller[e];t&&t.playlist&&t.pause()},AppboxPlayer.prototype.resumeChannel=function(e){var t=this.controller[e];t&&t.playlist&&t.resume()},AppboxPlayer.prototype.onChannelChanged=function(e,n){var t=this.getChannel(e);if(!n)return console.log("Clearing channel "+e),t.clear(),void("main"!=e&&delete this.controller[e]);var i=n.assets;if(console.log("Channel["+e+"]="+n.name),n.playlist?(n.playlist.map={},$.each(n.playlist.items,function(e,t){t.asset=i[t.assetId],t.key&&(n.playlist.map[t.key]=t)})):n.appId&&(n.app=i[n.appId],n.playlist={items:[n.app]}),t.playlist=n.playlist,t.metadata=n.metadata,this.testApp&&"main"==e)return console.log("Running test app, ignoring "+n.name),t.stageApplication(this.testApp),void(this.testApp=null);t.onChange(n)};var ChannelController=function(e,t){this.name=e,this.stageElem=t};ChannelController.prototype.setStage=function(e){this.stage=e},ChannelController.prototype.start=function(e){this.stage=e},ChannelController.prototype.clear=function(){this.stage&&(this.stage.dispose(),this.stage=null)},ChannelController.prototype.getPlaylist=function(){return this.stage&&this.stage.getPlaylist(),null},ChannelController.prototype.pause=function(){this.stage&&this.stage.pause()},ChannelController.prototype.resume=function(){this.stage&&this.stage.resume()},ChannelController.prototype.onChange=function(e){var t,n,i,s=e.playlist;"app"==e.sourceType?(i=e.metadata&&e.metadata.path?e.metadata.path:(t=e.metadata&&e.metadata.index?e.metadata.index:"index.html",n=e.app,e.assetBase+n.filename.substring(0,n.filename.lastIndexOf("."))+"/"+t),this.stageApplication(i)):"iptv"==e.sourceType?this.stageIPTV(e.url):s&&s.items&&0<s.items.length?this.stagePlaylist(s):console.log("Playlist is empty for schedule",e)},ChannelController.prototype.stageApplication=function(e){console.log("Playing application: "+e),this.stage&&(this.stage.dispose(),this.stage=null),this.stageElem?this.stage=new AppStage(this.stageElem,e):console.log("Channel "+this.name+" has not yet been staged")},ChannelController.prototype.stagePlaylist=function(e){this.stageElem||console.log("Channel "+this.name+" has not yet been staged"),this.stage&&(this.stage.dispose(),this.stage=null),this.stageElem&&(this.stage=new Stage(this.stageElem,e))},ChannelController.prototype.stageIPTV=function(e){this.stageElem||console.log("Channel "+this.name+" has not yet been staged"),this.stage&&(this.stage.dispose(),this.stage=null),this.stageElem?this.stage=new IPTVStage(this.stageElem,e):console.log("Channel "+this.name+" has not yet been staged")};var Stage=function(e,t){this.el=e instanceof jQuery?e[0]:e,$(this.el).empty(),this.init(t)};Stage.prototype={init:function(e){this.odd=$("<div id='stage1' class='stage-container'></div>"),this.even=$("<div id='stage2' class='stage-container'></div>"),this.odd.appendTo(this.el),this.even.appendTo(this.el),this.current=null,e&&(e.repeat=!0,this.player=new Playlist(e),this.player.start(this))},getPlaylist:function(){return this.player},pause:function(){this.player&&this.player.pause()},resume:function(){this.player&&this.player.resume()},dispose:function(){console.log("Dispose stage: "+this.el.getAttribute("id")),this.player&&(this.player.stop(),this.player=null),$(this.el).empty()},next:function(){return this.previous=this.current,this.current=this.previous==this.even?this.odd:this.even,this.current},transition:function(e,t){var n,i;t&&"fade"==e?(this.current.attr("pl","fadein"),this.current.stop(!0),this.current.fadeIn({duration:t}),this.current.css({left:"0px"}),this.previous&&((i=this).previous.attr("pl","fadeout"),this.previous.stop(!0),this.previous.fadeOut({duration:t},function(){i.emptyContainer(i.previous)}))):t&&"slide"==e?(n=$(this.previous).width(),this.current.attr("pl","slidein"),this.current.stop(!0),this.current.css({opacity:1,display:"block",left:n+"px"}),this.current.animate({left:"0px"},t),this.previous&&((i=this).previous.attr("pl","slideout"),this.previous.stop(!0),this.previous.animate({left:"-"+n+"px"},t,function(){i.emptyContainer(i.previous)}))):(this.current.show(),this.previous&&(this.previous.hide(),this.emptyContainer(this.previous)))},emptyContainer:function(e){e.children().filter("video").each(function(){this.pause()}),e.empty()}};var AppStage=function(e,t){this.el=e instanceof jQuery?e[0]:e,this.init(t)};AppStage.prototype={init:function(e){$(this.el).empty();var t=$('<iframe width="100%" height="100%" frameborder="0" />');t.attr("src",e),t.appendTo(this.el),this.iframe=t},dispose:function(){console.log("Dispose app stage: "+this.el.getAttribute("id")),$(this.el).empty()}};var IPTVStage=function(e,t){this.el=e instanceof jQuery?e[0]:e,this.init(t)};IPTVStage.prototype={init:function(e){$(this.el).empty();var t=Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString();console.log("IPTV Stage: "+t+", url: "+e),$('<video id="iptv-'+t+'" class="iptv-video video-js vjs-default-skin"><source id="iptv-src-'+t+'" src="'+e+'" type="application/x-mpegURL"></video>').appendTo(this.el),videojs("iptv-"+t).play()},dispose:function(){console.log("Dispose iptv stage: "+this.el.getAttribute("id")),$(this.el).empty()}};var Playlist=function(e){this.model=e,this.assetBase=e.assetBase||"/",this.metadata=e.metadata||{}};Playlist.prototype={start:function(e){this.running=!0,console.log("Start playlist "+this.model.name),this.stage=e||new Stage($("body")),this.stage.player&&this.stage.player.stop(),(this.stage.playlist=this).attached=!1,this.stageItem(0)},getItem:function(e){return this.model.map?this.model.map[e]:null},getItemPath:function(e){var t=this.model.map?this.model.map[e]:null;if(t)return"/"+t.asset.filename;throw"Failed to find "+e+" in "+this.model.name},stageItem:function(e){this.index=e;var t,n,i,s,r,a=this.model.items[e],o=a.asset;!this.attached||1<this.model.items.length?(t=this.stage.next(),0==o.type.indexOf("image")?(o.el||("tile"==a.fill?((n=$("<div class='stage-tile'></div>")).css({"background-image":"url('"+this.assetBase+o.filename+"')"}),o.el=n):((i=$("<img>").attr("src",this.assetBase+o.filename)).addClass("stage-"+a.fill),o.el=i)),o.el.appendTo(t)):0==o.type.indexOf("video")?(o.el||(o.el=$("<video class='stage-video' type='video/mp4' src='"+this.assetBase+o.filename+"'></video>"),o.el.addClass("stage-"+a.fill)),o.el.appendTo(t),o.el[0].play()):"application/x-zip-compressed"==o.type||o.type.endsWith("zip")?(s=o.filename.substring(0,o.filename.lastIndexOf("."))+"/index.html",(r=$('<iframe width="100%" height="100%" frameborder="0" />')).attr("src",s),r.appendTo(t)):console.log("Unsupported asset type: "+o.type),this.stage.transition(a.transition,a.transitionDuration),this.attached=!0):(console.log("Loop single item"),0==o.type.indexOf("video")&&(o.el[0].currentTime=0,o.el[0].play())),this.startWait(a.displayDuration),0==e&&this.triggerStarted()},startWait:function(e){this.waitStart=Date.now(),this.waitTime=e,this.waitId&&(clearTimeout(this.waitId),this.waitId=0),this.waitId=setTimeout($.proxy(this.itemComplete,this),e)},pause:function(){this.running?(console.log("Pausing: "+this.model.name),this.pauseTime=Date.now(),clearTimeout(this.waitId),this.waitId=0,this.running=!1):console.log("Already paused: "+this.model.name)},resume:function(){this.running?console.log("Already running: "+this.model.name):(this.running=!0,this.startWait(this.waitTime-(this.pauseTime-this.waitStart)))},stop:function(){console.log("Stopping: "+this.model.name),clearTimeout(this.waitId),this.waitId=0,this.running=!1},restart:function(){this.running?console.log("Already running: "+this.model.name):(this.running=!0,this.stageItem(0))},itemComplete:function(){var e=this.index;if(this.index++,this.index>=this.model.items.length){if(!this.model.repeat)return this.triggerCompleted();this.index=0,$(this).trigger("repeat")}(e!=this.index||this.model.repeat&&1==this.model.items.length)&&this.stageItem(this.index)},triggerStarted:function(){$(this).trigger("started")},triggerCompleted:function(){$(this).trigger("completed")},on:function(e,t){$(this).on(e,t)}};var MAX_TIMEOUT_VALUE=Math.pow(2,31)-1,ScheduledJob=function(e,t){this.callback=t,e instanceof Date?this.setTimeout(e):(this.rule=e,this.setupNextInvocation())};ScheduledJob.prototype.setupNextInvocation=function(){var e=this.nextInvocation();e&&(console.log("Next run: "+e),this.setTimeout(e.getTime()-Date.now()))},ScheduledJob.prototype.nextInvocation=function(){return this.rule?this.rule.nextRun():null},ScheduledJob.prototype.setTimeout=function(e){var t=this;e<=MAX_TIMEOUT_VALUE?this.timerId=setTimeout(function(){console.log("Running job"),t.callback(),t.rule&&t.setupNextInvocation()},e):(this.deferred=e-MAX_TIMEOUT_VALUE,this.timerId=setTimeout(function(){t.setTimeout(t.deferred)},MAX_TIMEOUT_VALUE))},ScheduledJob.prototype.cancel=function(){clearTimeout(this.timerId)};var RecurrenceRule=function(){this.date=new Date,this.hour=0,this.minute=0,this.second=0};function calculateNextRun(e,t){var n=(t=0<=compareTime({hour:(t=t||new Date).getHours(),minute:t.getMinutes(),second:t.getSeconds()},e)?new Date(t.getFullYear(),t.getMonth(),t.getDate()+1,e.hour,e.minute,e.second):new Date(t.getFullYear(),t.getMonth(),t.getDate(),e.hour,e.minute,e.second)).getDay();if(e.dayOfWeek&&0<e.dayOfWeek.length){if(!e.dayOfWeekIndex){e.dayOfWeekIndex=[0,0,0,0,0,0,0];for(var i=0;i<e.dayOfWeek.length;i++)e.dayOfWeekIndex[e.dayOfWeek[i]]=1}for(i=0;i<7;i++)if(e.dayOfWeekIndex[(n+i)%7]){t.setDate(t.getDate()+i),n=(n+i)%7;break}}return t}function compareTime(e,t){var n=e.hour-t.hour;return 0!=n||0!=(n=e.minute-t.minute)?n:e.second-t.second}RecurrenceRule.prototype.nextRun=function(){return this.date=calculateNextRun(this,this.date),this.date};var Scheduler={RecurrenceRule:RecurrenceRule,scheduleJob:function(e,t){return new ScheduledJob(e,t)}};function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function _createClass(e,t,n){return t&&_defineProperties(e.prototype,t),n&&_defineProperties(e,n),e}var DaysOfWeekArray=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],Schedule=function(){function o(e,t){_classCallCheck(this,o),this.manager=e;"00:00"==(this.sched=t).startTime&&("00:00"==t.endTime||t.endTime);var n=[];if(t.days.forEach(function(e,t){n.push(DaysOfWeekArray.indexOf(e))}),0!=n.length){var i=new Scheduler.RecurrenceRule;i.dayOfWeek=n,r=t.startTime.split(":"),i.hour=parseInt(r[0]),i.minute=parseInt(r[1]),this.startRule=i,this.startTimeOfDay=60*i.hour+i.minute;var s=new Scheduler.RecurrenceRule,r=t.endTime.split(":");if(s.hour=parseInt(r[0]),s.minute=parseInt(r[1]),24==s.hour){s.hour=23,s.minute=59,s.second=59,s.dayOfWeek=n.slice();for(var a=0;a<s.dayOfWeek.length;a++)s.dayOfWeek[a]=(s.dayOfWeek[a]+1)%7}else s.dayOfWeek=n;if(this.endRule=s,this.endTimeOfDay=60*s.hour+s.minute,Logger.info(t.name+" rules start: "+JSON.stringify(i)+", end: "+JSON.stringify(s)),t.endDate){if(r=t.endDate.split("-"),this.endDate=new Date(parseInt(r[0]),parseInt(r[1])-1,parseInt(r[2]),s.hour,s.minute,s.second),!(this.endDate.getTime()>Date.now()))return Logger.info(t.name+" is expired"),void this.exit();Logger.info("Set end of "+t.name+" at "+this.endDate),this.exitJob=Scheduler.scheduleJob(this.endDate,this.exit.bind(this))}t.startDate?(r=t.startDate.split("-"),this.startDate=new Date(parseInt(r[0]),parseInt(r[1])-1,parseInt(r[2])),this.startDate.getTime()<=Date.now()?this.enter():(Logger.info("Set start of "+t.name+" at "+this.startDate),this.enterJob=Scheduler.scheduleJob(this.startDate,this.enter.bind(this)))):this.enter(),this.sched.metadata&&this.sched.metadata.priority&&(this.priorityMap=this.sched.metadata.priority,global.signageManager.on("envChanged",this.onEnvChanged.bind(this)))}else Logger.warn(t.name+" not scheduled for any day of the week")}return _createClass(o,[{key:"onEnvChanged",value:function(e){var t,n,i=e.key,s=(e.oldValue,e.newValue),r=e.trigger;i in this.priorityMap?(this.sched.priorityTrigger=r,n=this.priorityMap[i],Logger.info("Env "+i+" trigger priority "+n+" for "+this.sched.name+", trigger: "+JSON.stringify(r)),this.setPriority(n)):(t=i+"="+s)in this.priorityMap&&(this.sched.priorityTrigger=r,n=this.priorityMap[t],Logger.info("Env "+t+" trigger priority "+n+" for "+this.sched.name+", trigger: "+JSON.stringify(r)),this.setPriority(n))}},{key:"setPriority",value:function(e){this.sched.priority!=e&&(this.sched.priority=e,this.manager.priorityChanged(this.sched))}},{key:"isActiveDay",value:function(e){return 0<=this.startRule.dayOfWeek.indexOf(e.getDay())}},{key:"enter",value:function(){var e,t;Logger.info("Enter date "+this.sched.name),this.startRule&&this.endRule?(t=60*(e=new Date).getHours()+e.getMinutes(),this.startJob||(this.startJob=Scheduler.scheduleJob(this.startRule,this.enterTime.bind(this))),this.endJob||(this.endJob=Scheduler.scheduleJob(this.endRule,this.exitTime.bind(this))),this.isActiveDay(e)?t>=this.startTimeOfDay&&(0==this.endTimeOfDay||t<this.endTimeOfDay)?this.enterTime():Logger.info("Not in active time interval. ToD: "+t+", start: "+this.startTimeOfDay+", end: "+this.endTimeOfDay):Logger.info("Not active today"),this.startJob?(this.nextStart=this.startJob.nextInvocation(),Logger.info("Next start: "+(this.nextStart?this.nextStart.toLocaleString():"None"))):Logger.warn("Start Job is null. Rule: "+JSON.stringify(this.startRule)),this.endJob?(this.nextEnd=this.endJob.nextInvocation(),Logger.info("Next end: "+(this.nextEnd?this.nextEnd.toLocaleString():"None"))):Logger.warn("End Job is null. Rule: "+JSON.stringify(this.endRule))):(Logger.info("Run full time: "+this.sched.name),this.enterTime())}},{key:"enterTime",value:function(){Logger.info("Enter time "+this.sched.name),this.manager.enter(this.sched)}},{key:"exitTime",value:function(){0==this.startTimeOfDay&&0==this.endTimeOfDay&&this.isActiveDay(new Date)?Logger.info("Continue "+this.sched.name):(Logger.info("Exit time "+this.sched.name),this.manager.exit(this.sched))}},{key:"exit",value:function(){Logger.info("Exit date "+this.sched.name)}},{key:"cancel",value:function(){Logger.info("Cancel "+this.sched.name),this.enterJob&&this.enterJob.cancel(),this.exitJob&&this.exitJob.cancel(),this.startJob&&this.startJob.cancel(),this.endJob&&this.endJob.cancel()}}]),o}();function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function _createClass(e,t,n){return t&&_defineProperties(e.prototype,t),n&&_defineProperties(e,n),e}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&_setPrototypeOf(e,t)}function _setPrototypeOf(e,t){return(_setPrototypeOf=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function _createSuper(n){var i=_isNativeReflectConstruct();return function(){var e,t=_getPrototypeOf(n);return _possibleConstructorReturn(this,i?(e=_getPrototypeOf(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments))}}function _possibleConstructorReturn(e,t){return!t||"object"!==_typeof(t)&&"function"!=typeof t?_assertThisInitialized(e):t}function _assertThisInitialized(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}function _getPrototypeOf(e){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function parseTime(e){if(!e)return 0;var t=e.split(":"),n=0;return 1==t.length?n=parseInt(t[0]):2==t.length?n=60*parseInt(t[0])+parseInt(t[1]):3==t.length&&(n=60*(60*parseInt(t[0])+parseInt(t[1]))+parseInt(t[2])),1e3*n}var ScheduleManager=function(){_inherits(n,EventEmitter);var t=_createSuper(n);function n(){var e;return _classCallCheck(this,n),(e=t.call(this)).schedules=[],e.channels={},e}return _createClass(n,[{key:"setAngle",value:function(e){this.angle=e}},{key:"processSchedules",value:function(e){var n=this,i=(e.host?e.host:"")+e.assetBase,s={};e.assets.forEach(function(e){s[e._id]=e}),e.schedules&&e.schedules.forEach(function(e){e.sourceType?(e.sourceType=e.sourceType.toLowerCase(),"adbox video"==e.sourceType&&(e.sourceType="adbox")):e.sourceType="playlist",e.assets=s,e.assetBase=i}),e.schedules.forEach(function(e){var t;"adbox"==e.sourceType&&(logger.info("Caching adbox asset "+e.assetId),t=n.cache.getAdBoxLoader(e.assetId),e.getMediaSource=function(){return t})});var r={};e.playlists.forEach(function(t){if((r[t._id]=t).assetBase=i,t.metadata)try{t.metadata=JSON.parse(t.metadata)}catch(e){logger.error("Failed to parse metadata for playlist: "+t.name,e),logger.warn(t.metadata)}t.items.forEach(function(e){var t=s[e.assetId];e.asset=t,e.fill&&(e.fill=e.fill.toLowerCase()),e.transition&&(e.transition=e.transition.toLowerCase()),e.displayDuration=parseTime(e.displayDuration),e.displayDuration||(e.displayDuration=1e3*t.duration,e.displayDuration||(e.displayDuration=5e3)),e.transitionDuration=parseTime(e.transitionDuration)})}),e.schedules.forEach(function(t){if(t.metadata)try{t.metadata=JSON.parse(t.metadata)}catch(e){logger.error("Failed to parse metadata for schedule: "+t.name,e),logger.warn(t.metadata)}var e;"playlist"==t.sourceType&&(e=t.playlist,t.playlist=r[e],t.playlist||logger.error("Playlist "+e+" not found for schedule "+t.name))}),this.load(e.schedules)}},{key:"load",value:function(e){var n=this;this.clearAll(),0==e.length?setTimeout(function(){n.loadDefaultBrowser()},5e3):e.forEach(function(e,t){n.addSchedule(new Schedule(n,e))})}},{key:"clearAll",value:function(){for(var e in this.schedules.forEach(function(e){e.cancel()}),this.schedules=[],this.channels)this.emit("channelContentChanged",e.name,null);this.channels={}}},{key:"addSchedule",value:function(e){this.schedules.push(e)}},{key:"priorityChanged",value:function(e){var t=this.channels[e.channel];t?t.markDirty():Logger.error("Channel "+e.channel+" not found")}},{key:"enter",value:function(e){var t=this.channels[e.channel];t||(this.channels[e.channel]=t=new Channel(this,e.channel)),t.add(e)}},{key:"exit",value:function(e){var t=this.channels[e.channel];t?t.remove(e):Logger.warn("Error removing "+e.name+". Unknown channel: "+e.channel)}},{key:"loadDefaultBrowser",value:function(){Logger.warn("Load unconfigured browser"),this.stopOldPlayer()}},{key:"setNewContent",value:function(e,t,n){var i=t?t.sourceType:null;"app"==i&&(i="playlist"),"playlist"==i||"website"==i||("adbox"==i||"iptv"==i||Logger.warn("Unknown sourceType: "+i)),"main"==e&&(this.priorityTrigger=n,this.priorityTime=Date.now()),this.emit("channelContentChanged",e,t)}},{key:"stopOldPlayer",value:function(){this.process&&(Logger.info("Stopping old container process "+this.player),this.process.stop())}},{key:"getActiveChannels",value:function(e){for(var t in this.channels){(t=this.channels[t])&&t.active&&e(t.name,t.active)}}}]),n}();
